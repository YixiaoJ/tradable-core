/******  Copyright 2016 Tradable ApS; @license MIT; v1.11  ******/
window.trEmbJQ=jQuery.noConflict(!0),("undefined"==typeof window.console||"undefined"==typeof window.console.log)&&(window.console={log:function(){}}),window.tradableEmbed=function(e){"use strict";function t(){function t(t,o){var c,r,a;o.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+A,!1);var i=t.replace("#","").split("&");return e(i).each(function(e,t){var n=t.split("="),o=n[0],i=n[1];"access_token"===o?c=i:"endpointURL"===o?r=i:"expires_in"===o&&(a=i)}),c&&r?(o.enableTrading(c,r,a),"osLaunch"===window.name&&window.close(),!0):!1}var o=!1,r=window.opener;if(r&&"osAddBroker"===window.name){try{r.tradableEmbed.enableTrading(void 0,void 0,void 0,!0)}catch(a){}window.close()}else if(r&&"osLaunch"===window.name){var i=window.location.hash;if(i){try{r.postMessage("replace your location","*"),o=t(i,r.tradableEmbed)}catch(a){o=!1}o||(o=t(i,x))}}else window.location.hash&&-1!==window.location.hash.indexOf("access_token")&&-1!==window.location.hash.indexOf("endpointURL")&&-1!==window.location.hash.indexOf("expires_in")?o=t(window.location.hash,x):x.tradingEnabled&&(s(),o=!0);o||(console.log("Initiating without authentication..."),e(document).ready(function(){c()}))}function n(){var e="test";try{return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(t){return!1}}function o(e,t,n,o){var c=window.screenLeft?window.screenLeft:window.screenX,r=window.screenTop?window.screenTop:window.screenY,a=c+window.innerWidth/2-n/2,i=r+window.innerHeight/2-o/2;return window.open(e,t,"toolbar=no, titlebar=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+n+", height="+o+", top="+i+", left="+a)}function c(){e(x.readyCallbacks).each(function(e,t){t()}),x.notifiedCallbacks=!0}function r(){x.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+A,!1),e(R).each(function(e,t){t()}),c()}function a(t){e(q).each(function(e,n){n(t)})}function i(){e(P).each(function(e,t){t()})}function u(t,n){console.log("Initializing values for current account");var o=!1;return x.tradingEnabled&&(x.tradingEnabled=!1,o=!0),x.getInstruments().then(function(n){x.availableCategories.splice(0,x.availableCategories.length),x.availableInstruments.splice(0,x.availableInstruments.length),x.availableSymbols.splice(0,x.availableSymbols.length),x.availableCurrencies.splice(0,x.availableCurrencies.length);var c=["100","200","225","spx","h33","nas","u30","e50","f40","d30","e35","i40","z30","s30","uso","uko"];return e(n).each(function(t,n){if(x.availableInstruments.push(n),x.availableSymbols.push(n.symbol),"FOREX"===n.type&&6===n.symbol.length){var o=n.symbol.toLowerCase().substring(0,3),r=n.symbol.toLowerCase().substring(3,6);-1===e.inArray(o,x.availableCurrencies)&&-1===e.inArray(o,c)&&x.availableCurrencies.push(o),-1===e.inArray(r,x.availableCurrencies)&&-1===e.inArray(o,c)&&x.availableCurrencies.push(r)}-1===e.inArray(n.type,x.availableCategories)&&x.availableCategories.push(n.type)}),o&&(x.tradingEnabled=!0),i(),t&&"function"==typeof t?t(x.accounts):this},function(e){return n&&"function"==typeof n?n(e):this})}function s(){console.log("Validating token..."),x.getAccounts().then(function(e){x.enableTrading(x.accessToken,x.authEndpoint)},function(){x.tradingEnabled=!1,n()&&localStorage.setItem("tradingEnabled:"+A,x.tradingEnabled),c()})}function l(e,t){console.log("Accounts initialized");var n,o=localStorage.getItem("selectedAccount:"+A);if(e&&x.accounts.length>t){var r=x.accounts.length-1;n=x.accounts[r].uniqueId}else if(o&&x.accountMap[o])n=o;else{var r=x.accounts.length-1;n=x.accounts[r].uniqueId}x.setSelectedAccount(n,function(){c()})}function d(){if(x.tradingEnabled&&!U){U=!0;var t=[];e(x.symbolKeysForAccountUpdates).each(function(n,o){var c=o.substring(0,o.indexOf(":"));-1===e.inArray(c,t)&&t.push(c)}),x.getSnapshot(t).then(function(t){x.lastSnapshot=t,e.each(w,function(e,n){n(t)}),U=!1},function(){U=!1})}}function f(e,t,n){return t||n?e.then(function(e){return"function"==typeof t?t(e):void 0},function(e,t,o){return"function"==typeof n?n(e,t,o):void 0}):e}function p(e){var t;return t=e?x.auth_loc+"&broker_id="+e:x.auth_loc}function g(e){var t=0;if(0==e.length)return t;for(M=0;M<e.length;M++)L=e.charCodeAt(M),t=(t<<5)-t+L,t&=t;return t}function m(){return-1!=navigator.userAgent.indexOf("MSIE")||/rv:11.0/i.test(navigator.userAgent)}var A,h,b="js-1.11",v=location.href;if("undefined"!=typeof tradableEmbedConfig)A=tradableEmbedConfig.appId,h=tradableEmbedConfig.customOAuthURL,tradableEmbedConfig.redirectURI&&(v=tradableEmbedConfig.redirectURI);else{var T="tradable-embed";0==e("#"+T).length&&(T="tradable-api"),A=e("#"+T).attr("data-app-id"),h=e("#"+T).attr("data-custom-oauth-url");var y=e("#"+T).attr("data-redirect-uri");y&&(v=y)}var I="api.tradable.com";A>2e5&&(I="api-staging.tradable.com",console.log("Starting in staging mode..."));var E=localStorage.getItem("accessToken:"+A),k=localStorage.getItem("authEndpoint:"+A),O=localStorage.getItem("tradingEnabled:"+A),S=localStorage.getItem("expirationTimeUTC:"+A);!O||k&&E&&S||(O=!1,n()&&localStorage.setItem("tradingEnabled:"+A,O));var P=[],w=[],F=[],R=[],C=[],q=[],U=!1,x={app_id:A,oauth_host:I,auth_loc:h?h:"https://"+I+"/oauth/authorize?client_id="+A+"&scope=trade&response_type=token&redirect_uri="+v,add_broker_loc:"https://"+I+"/addBroker?clientId="+A+"&redirectURI="+v,auth_window:null,authEndpoint:k,accessToken:E,notifiedCallbacks:!1,tradingEnabled:O,expirationTimeUTC:S,readyCallbacks:[],accounts:[],accountIdsToExclude:[],accountMap:{},selectedAccount:null,selectedAccountId:null,availableCategories:[],availableInstruments:[],availableSymbols:[],availableCurrencies:[],lastSnapshot:null,symbolKeysForAccountUpdates:[],accountUpdateInterval:null,accountUpdateMillis:700,authenticate:function(e){console.log("Starting oauth flow..."),x.tradingEnabled?s():location.href=p(e)},authenticateWithWindow:function(e){return m()?(console.log("Window opener no supported in IE, redirecting to oauth..."),x.authenticate(e)):(console.log("Opening oauth window..."),void(x.auth_window=o(p(e),"osLaunch",450,450)))},openAddBrokerWindow:function(){m()&&window.open("https://api.tradable.com"),x.auth_window=o(x.add_broker_loc,"osAddBroker",450,450)},enableWithAccessToken:function(e,t,n){x.enableTrading(e,t,n,!0)},signOut:function(){n()&&(localStorage.removeItem("accessToken:"+A),localStorage.removeItem("authEndpoint:"+A),localStorage.removeItem("tradingEnabled:"+A),localStorage.removeItem("expirationTimeUTC:"+A)),x.tradingEnabled=!1,c()},onEmbedReady:function(e){x.readyCallbacks.push(e),x.notifiedCallbacks&&e()},onAccountUpdated:function(t){if(t){0===w.length&&(x.accountUpdateInterval=setInterval(d,x.accountUpdateMillis));var n=g(t.toString());-1===e.inArray(n,F)&&(w.push(t),F.push(n))}},setAccountUpdateFrequencyMillis:function(e){e&&e>0?(x.accountUpdateMillis=e,x.accountUpdateInterval&&(clearInterval(x.accountUpdateInterval),x.accountUpdateInterval=setInterval(d,x.accountUpdateMillis))):console.error("Please specify a valid update frequency")},addSymbolToUpdates:function(t,n){if(-1!==t.indexOf(":"))return void console.error("It is not allowed to include a colon ':' in the updateClientId");var o=n+":"+t;-1===e.inArray(o,x.symbolKeysForAccountUpdates)&&-1!==e.inArray(n,x.availableSymbols)&&x.symbolKeysForAccountUpdates.push(o)},removeSymbolFromUpdates:function(t,n){var o=n+":"+t;x.symbolKeysForAccountUpdates=e.grep(x.symbolKeysForAccountUpdates,function(e){return e!=o})},onAccountSwitch:function(t){t&&-1===e.inArray(t,P)&&P.push(t)},onTokenExpired:function(t){t&&-1===e.inArray(t,R)&&R.push(t)},onError:function(t){-1===e.inArray(t,q)&&q.push(t)},onTokenWillExpire:function(t){function n(){var t=x.getRemainingTokenMillis();t&&t>0&&18e5>t&&e(C).each(function(e,n){n(t)})}0===C.length&&setInterval(n,3e5),-1===e.inArray(t,C)&&C.push(t)},getRemainingTokenMillis:function(){return x.expirationTimeUTC||console.log("You need to authenticate before calling this method"),x.expirationTimeUTC-(new Date).getTime()},makeOsRequest:function(t,n,o,c,i,u,s){var l;"user"!==t&&"accounts"!==t?l="https://"+I:void 0!==o&&null!==o&&0===o.length?l=x.authEndpoint:x.accountMap[o]?l=x.accountMap[o].endpointURL:console.info("Please specify a valid accountId or method");var d=e.ajax({type:n,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+x.accessToken),e.setRequestHeader("x-tr-embed-sdk",b)},crossDomain:!0,url:o&&o.length>0?l+"/v1/"+t+"/"+o+"/"+c:l+"/v1/"+t+"/"+c,contentType:"application/json; charset=utf-8",data:i?JSON.stringify(i):void 0,dataType:"json"});return d.then(function(){},function(e,t,n){!e.responseJSON||403!==e.responseJSON.httpStatus&&502!==e.responseJSON.httpStatus||(r(),a(e.responseJSON))}),u||s?d.then(function(e){return"function"==typeof u?u(e):void 0},function(e,t,n){return"function"==typeof s?s(e,t,n):void 0}):"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(d):d},makeAccountRequest:function(e,t,n,o,c,r){return x.makeOsRequest("accounts",e,t,n,o,c,r)},setSelectedAccount:function(e,t,o){return x.accountMap[e]?(x.selectedAccount=x.accountMap[e],x.selectedAccountId=e,u(function(){n()&&localStorage.setItem("selectedAccount:"+A,e),t&&t()},function(e){(502===e.status||403===e.status)&&(x.excludeCurrentAccount(),x.accounts.length>0&&s()),o&&o(e)})):void console.error("Can't set account id to: "+e)},excludeCurrentAccount:function(){var e=x.selectedAccountId,t=x.accounts.indexOf(x.selectedAccount);t>-1&&x.accounts.splice(t,1),delete x.accountMap[e],x.accountIdsToExclude.push(e)},getInstrumentFromSymbol:function(t){if(!t)return null;var n=null;return e(x.availableInstruments).each(function(e,o){return o.symbol.toUpperCase()===t.toUpperCase()?(n=o,!1):void 0}),n},getInstrumentFromBrokerageAccountSymbol:function(t){var n=null;return e(x.availableInstruments).each(function(e,o){return o.brokerageAccountSymbol.toUpperCase()===t.toUpperCase()?(n=o,!1):void 0}),n},getAccountById:function(e){return x.accountMap[e]},getUser:function(e,t){return x.makeOsRequest("user","GET","","",null,e,t)},getAppInfo:function(e,t){return x.makeOsRequest("apps","GET","",x.app_id,null,e,t)},getBrokers:function(e,t){return x.makeOsRequest("brokers","GET","","",null,e,t)},authenticateWithCredentials:function(e,t,n,o,c,r){var a={appId:e,brokerId:t,login:n,password:o},i=x.makeOsRequest("authenticate","POST","","",a).then(function(e){x.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)});return f(i,c,r)},createDemoAccount:function(e,t,n,o){var c={appId:e,type:t},r=x.makeOsRequest("createDemoAccount","POST","","",c).then(function(e){x.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)});return f(r,n,o)},createForexDemoAccount:function(e,t,n){return x.createDemoAccount(e,"FOREX",t,n)},createStocksDemoAccount:function(e,t,n){return x.createDemoAccount(e,"STOCKS",t,n)},refreshAuthentication:function(e,t,n,o,c){var r={refreshTokenValue:e,appSecret:t},a=x.makeOsRequest("refreshAuthentication","POST","","",r).then(function(e){x.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)});return f(a,o,c)},getAccounts:function(t,n){var o=x.makeAccountRequest("GET","","",null).then(function(t){x.accounts.splice(0,x.accounts.length),x.accountMap={},e(t.accounts).each(function(e,t){t.uniqueId&&"NA"!==t.uniqueId&&x.accountIdsToExclude.indexOf(t.uniqueId)<=-1&&(x.accounts.push(t),x.accountMap[t.uniqueId]=t)})});return f(o,t,n)},getCandles:function(e,t,n,o,c,r){return x.getCandlesForAccount(x.selectedAccountId,e,t,n,o,c,r)},getCandlesForAccount:function(e,t,n,o,c,r,a){var i={symbol:t,from:n,to:o,aggregation:c};return x.makeAccountRequest("POST",e,"candles/",i,r,a)},getSnapshot:function(e,t,n){return x.getSnapshotForAccount(x.selectedAccountId,e,t,n)},getSnapshotForAccount:function(e,t,n,o){var c={symbols:t};return x.makeAccountRequest("POST",e,"",c,n,o)},getInstruments:function(e,t){return x.getInstrumentsForAccount(x.selectedAccountId,e,t)},getInstrumentsForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"instruments/",null,t,n)},getMetrics:function(e,t){return x.getMetricsForAccount(x.selectedAccountId,e,t)},getMetricsForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"metrics/",null,t,n)},getOrders:function(e,t){return x.getOrdersForAccount(x.selectedAccountId,e,t)},getOrdersForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"orders/",null,t,n)},placeMarketOrder:function(e,t,n,o,c){return x.placeOrder(e,0,t,n,"MARKET",o,c)},placeMarketOrderForAccount:function(e,t,n,o,c,r){return x.placeOrderForAccount(e,t,0,n,o,"MARKET",c,r)},placeLimitOrder:function(e,t,n,o,c,r){return x.placeOrder(e,t,n,o,"LIMIT",c,r)},placeLimitOrderForAccount:function(e,t,n,o,c,r,a){return x.placeOrderForAccount(e,t,n,o,c,"LIMIT",r,a)},placeStopOrder:function(e,t,n,o,c,r){return x.placeOrder(e,t,n,o,"STOP",c,r)},placeStopOrderForAccount:function(e,t,n,o,c,r,a){return x.placeOrderForAccount(e,t,n,o,c,"STOP",r,a)},placeOrder:function(e,t,n,o,c,r,a){return x.placeOrderForAccount(x.selectedAccountId,e,t,n,o,c,r,a)},placeOrderForAccount:function(e,t,n,o,c,r,a,i){var u={amount:t,price:n,side:o,symbol:c,type:r};return x.makeAccountRequest("POST",e,"orders/",u,a,i)},getPendingOrders:function(e,t){return x.getPendingOrdersForAccount(x.selectedAccountId,e,t)},getPendingOrdersForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"orders/pending",null,t,n)},getOrderById:function(e,t,n){return x.getOrderByIdForAccount(x.selectedAccountId,e,t,n)},getOrderByIdForAccount:function(e,t,n,o){return x.makeAccountRequest("GET",e,"orders/"+t,null,n,o)},modifyOrderPrice:function(e,t,n,o){return x.modifyOrderPriceForAccount(x.selectedAccountId,e,t,n,o)},modifyOrderPriceForAccount:function(e,t,n,o,c){var r={price:n};return x.makeAccountRequest("PUT",e,"orders/"+t,r,o,c)},cancelOrder:function(e,t,n){return x.cancelOrderForAccount(x.selectedAccountId,e,t,n)},cancelOrderForAccount:function(e,t,n,o){return x.makeAccountRequest("DELETE",e,"orders/"+t,null,n,o)},getPositions:function(e,t){return x.getPositionsForAccount(x.selectedAccountId,e,t)},getPositionsForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"positions/",null,t,n)},closeAllPositions:function(e,t){return x.closeAllPositionsForAccount(x.selectedAccountId,e,t)},closeAllPositionsForAccount:function(e,t,n){return x.makeAccountRequest("DELETE",e,"positions/",null,t,n)},getOpenPositions:function(e,t){return x.getOpenPositionsForAccount(x.selectedAccountId,e,t)},getOpenPositionsForAccount:function(e,t,n){return x.makeAccountRequest("GET",e,"positions/open",null,t,n)},getPositionById:function(e,t,n){return x.getPositionByIdForAccount(x.selectedAccountId,e,t,n)},getPositionByIdForAccount:function(e,t,n,o){return x.makeAccountRequest("GET",e,"positions/"+t,null,n,o)},reducePositionToAmount:function(e,t,n,o){return x.reducePositionToAmountForAccount(x.selectedAccountId,e,t,n,o)},reducePositionToAmountForAccount:function(e,t,n,o,c){var r={amount:n};return x.makeAccountRequest("PUT",e,"positions/"+t,r,o,c)},closePosition:function(e,t,n){return x.closePositionForAccount(x.selectedAccountId,e,t,n)},closePositionForAccount:function(e,t,n,o){return x.makeAccountRequest("DELETE",e,"positions/"+t,null,n,o)},addOrModifyProtections:function(e,t,n,o,c){return x.addOrModifyProtectionsForAccount(x.selectedAccountId,e,t,n,o,c)},addOrModifyProtectionsForAccount:function(e,t,n,o,c,r){var a={takeprofit:n,stoploss:o};return x.makeAccountRequest("PUT",e,"positions/"+t+"/protections/",a,c,r)},cancelProtections:function(e,t,n){return x.cancelProtectionsForAccount(x.selectedAccountId,e,t,n)},cancelProtectionsForAccount:function(e,t,n,o){return x.makeAccountRequest("DELETE",e,"positions/"+t+"/protections/",null,n,o)},addOrModifyTakeProfit:function(e,t,n,o){return x.makeProtectionRequest("PUT",e,t,"TAKEPROFIT",n,o)},addOrModifyTakeProfitForAccount:function(e,t,n,o,c){return x.makeProtectionRequestForAccount("PUT",e,t,n,"TAKEPROFIT",o,c)},addOrModifyStopLoss:function(e,t,n,o){return x.makeProtectionRequest("PUT",e,t,"STOPLOSS",n,o)},addOrModifyStopLossForAccount:function(e,t,n,o,c){return x.makeProtectionRequestForAccount("PUT",e,t,n,"STOPLOSS",o,c)},cancelTakeProfit:function(e,t,n){return x.makeProtectionRequest("DELETE",e,0,"TAKEPROFIT",t,n)},cancelTakeProfitForAccount:function(e,t,n,o){return x.makeProtectionRequestForAccount("DELETE",e,t,0,"TAKEPROFIT",n,o)},cancelStopLoss:function(e,t,n){return x.makeProtectionRequest("DELETE",e,0,"STOPLOSS",t,n)},cancelStopLossForAccount:function(e,t,n,o){return x.makeProtectionRequestForAccount("DELETE",e,t,0,"STOPLOSS",n,o)},makeProtectionRequest:function(e,t,n,o,c,r){return x.makeProtectionRequestForAccount(e,x.selectedAccountId,t,n,o,c,r)},makeProtectionRequestForAccount:function(e,t,n,o,c,r,a){var i={price:o};return"DELETE"===e&&(i=null),x.makeAccountRequest(e,t,"positions/"+n+"/protections/"+c,i,r,a)},getPrices:function(e,t,n){return x.getPricesForAccount(x.selectedAccountId,e,t,n)},getPricesForAccount:function(e,t,n,o){var c={symbols:t};return x.makeAccountRequest("POST",e,"prices/",c,n,o)},makeCandleRequest:function(t,n,o,c,r){var a={symbols:n};r&&(a=r);var i=e.ajax({type:"POST",crossDomain:!0,url:"https://candles-api.tradable.com/"+t,contentType:"application/json; charset=utf-8",data:JSON.stringify(a),dataType:"json"});if(o||c)return i.then(function(e){return"function"==typeof o?o(e.dailyClose?e.dailyClose:e):void 0},function(e,t,n){return"function"==typeof c?c(e,t,n):void 0});var u=new e.Deferred;return i.then(function(e){return e.dailyClose?u.resolve(e.dailyClose):u.resolve(e)},function(e,t,n){return u.reject(e,t,n)}),"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(u.promise()):u.promise()},getLastDailyClose:function(e,t,n){return x.makeCandleRequest("dailyClose",e,t,n)},enableTrading:function(e,t,o,c){console.log("Activating TradableEmbed..."),e&&t&&(x.accessToken=e,x.authEndpoint=t,x.tradingEnabled=!0,n()&&(localStorage.setItem("accessToken:"+A,x.accessToken),localStorage.setItem("authEndpoint:"+A,x.authEndpoint),localStorage.setItem("tradingEnabled:"+A,x.tradingEnabled),o&&(x.expirationTimeUTC=(new Date).getTime()+1e3*parseInt(o),localStorage.setItem("expirationTimeUTC:"+A,x.expirationTimeUTC))));var r=x.accounts.length;x.getAccounts().then(function(e){l(c,r)})}};return t(),x;var M,L}(trEmbJQ);