/******  Copyright 2016 Tradable ApS; @license MIT; v1.12  ******/
var trEmbJQ=jQuery.noConflict(!0),jsGlobalObject="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:this;!function(e,t){"use strict";function n(){function e(e,n){var c,r,a;n.tradingEnabled=!1,o()&&localStorage.setItem("tradingEnabled:"+h,!1);var i=e.replace("#","").split("&");return t(i).each(function(e,t){var n=t.split("="),o=n[0],i=n[1];"access_token"===o?c=i:"endpointURL"===o?r=i:"expires_in"===o&&(a=i)}),c&&r?(n.enableTrading(c,r,a),"osLaunch"===window.name&&window.close(),!0):!1}var n=!1,c=window.opener;if(c&&"osAddBroker"===window.name){try{c.tradableEmbed.enableTrading(void 0,void 0,void 0,!0)}catch(a){}window.close()}else if(c&&"osLaunch"===window.name){var i=window.location.hash;if(i){try{c.postMessage("replace your location","*"),n=e(i,c.tradableEmbed)}catch(a){n=!1}n||(n=e(i,M))}}else window.location.hash&&-1!==window.location.hash.indexOf("access_token")&&-1!==window.location.hash.indexOf("endpointURL")&&-1!==window.location.hash.indexOf("expires_in")?n=e(window.location.hash,M):M.tradingEnabled&&(l(),n=!0);n||(console.log("Initiating without authentication..."),t(document).ready(function(){r()}))}function o(){var e="test";try{return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(t){return!1}}function c(e,t,n,o){var c=window.screenLeft?window.screenLeft:window.screenX,r=window.screenTop?window.screenTop:window.screenY,a=c+window.innerWidth/2-n/2,i=r+window.innerHeight/2-o/2;return window.open(e,t,"toolbar=no, titlebar=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+n+", height="+o+", top="+i+", left="+a)}function r(){t(M.readyCallbacks).each(function(e,t){t()}),M.notifiedCallbacks=!0}function a(){M.tradingEnabled=!1,o()&&localStorage.setItem("tradingEnabled:"+h,!1),t(C).each(function(e,t){t()}),r()}function i(e){t(U).each(function(t,n){n(e)})}function u(){t(w).each(function(e,t){t()})}function s(e,n){console.log("Initializing values for current account");var o=!1;return M.tradingEnabled&&(M.tradingEnabled=!1,o=!0),M.getInstruments().then(function(n){M.availableCategories.splice(0,M.availableCategories.length),M.availableInstruments.splice(0,M.availableInstruments.length),M.availableSymbols.splice(0,M.availableSymbols.length),M.availableCurrencies.splice(0,M.availableCurrencies.length);var c=["100","200","225","spx","h33","nas","u30","e50","f40","d30","e35","i40","z30","s30","uso","uko"];return t(n).each(function(e,n){if(M.availableInstruments.push(n),M.availableSymbols.push(n.symbol),"FOREX"===n.type&&6===n.symbol.length){var o=n.symbol.toLowerCase().substring(0,3),r=n.symbol.toLowerCase().substring(3,6);-1===t.inArray(o,M.availableCurrencies)&&-1===t.inArray(o,c)&&M.availableCurrencies.push(o),-1===t.inArray(r,M.availableCurrencies)&&-1===t.inArray(o,c)&&M.availableCurrencies.push(r)}-1===t.inArray(n.type,M.availableCategories)&&M.availableCategories.push(n.type)}),o&&(M.tradingEnabled=!0),u(),e&&"function"==typeof e?e(M.accounts):this},function(e){return n&&"function"==typeof n?n(e):this})}function l(){console.log("Validating token..."),M.getAccounts().then(function(e){M.enableTrading(M.accessToken,M.authEndpoint)},function(){M.tradingEnabled=!1,o()&&localStorage.setItem("tradingEnabled:"+h,M.tradingEnabled),r()})}function d(e,n){var o=new t.Deferred;console.log("Accounts initialized");var c,a=localStorage.getItem("selectedAccount:"+h),i=M.accounts.length-1;return c=e&&M.accounts.length>n?M.accounts[i].uniqueId:a&&M.accountMap[a]?a:M.accounts[i].uniqueId,M.setSelectedAccount(c,function(){r(),o.resolve()},function(e){o.reject(e)}),o}function f(){if(M.tradingEnabled&&!x){x=!0;var e=[];t(M.symbolKeysForAccountUpdates).each(function(n,o){var c=o.substring(0,o.indexOf(":"));-1===t.inArray(c,e)&&e.push(c)}),M.getSnapshot(e).then(function(e){M.lastSnapshot=e,t.each(F,function(t,n){n(e)}),x=!1},function(){x=!1})}}function p(e,t,n){return t||n?e.then(function(e){return"function"==typeof t?t(e):void 0},function(e,t,o){return"function"==typeof n?n(e,t,o):void 0}):e}function m(e){var t;return t=e?M.auth_loc+"&broker_id="+e:M.auth_loc}function g(e){var t,n,o=0;if(0===e.length)return o;for(t=0;t<e.length;t++)n=e.charCodeAt(t),o=(o<<5)-o+n,o&=o;return o}function A(){return-1!=navigator.userAgent.indexOf("MSIE")||/rv:11.0/i.test(navigator.userAgent)}("undefined"==typeof console||"undefined"==typeof console.log)&&(e.console={log:function(){}});var h,b,v="js-1.12",y=location.href;if("undefined"!=typeof tradableEmbedConfig)h=tradableEmbedConfig.appId,b=tradableEmbedConfig.customOAuthURL,tradableEmbedConfig.redirectURI&&(y=tradableEmbedConfig.redirectURI);else{var T="tradable-embed";0===t("#"+T).length&&(T="tradable-api"),h=t("#"+T).attr("data-app-id"),b=t("#"+T).attr("data-custom-oauth-url");var I=t("#"+T).attr("data-redirect-uri");I&&(y=I)}var E="api.tradable.com";h>2e5&&(E="api-staging.tradable.com",console.log("Starting in staging mode..."));var O=localStorage.getItem("accessToken:"+h),k=localStorage.getItem("authEndpoint:"+h),S=localStorage.getItem("tradingEnabled:"+h),P=localStorage.getItem("expirationTimeUTC:"+h);!S||k&&O&&P||(S=!1,o()&&localStorage.setItem("tradingEnabled:"+h,S));var w=[],F=[],R=[],C=[],q=[],U=[],x=!1,M={app_id:h,oauth_host:E,auth_loc:b?b:"https://"+E+"/oauth/authorize?client_id="+h+"&scope=trade&response_type=token&redirect_uri="+y,add_broker_loc:"https://"+E+"/addBroker?clientId="+h+"&redirectURI="+y,auth_window:null,authEndpoint:k,accessToken:O,notifiedCallbacks:!1,tradingEnabled:S,expirationTimeUTC:P,readyCallbacks:[],accounts:[],accountIdsToExclude:[],accountMap:{},selectedAccount:null,selectedAccountId:null,availableCategories:[],availableInstruments:[],availableSymbols:[],availableCurrencies:[],lastSnapshot:null,symbolKeysForAccountUpdates:[],accountUpdateInterval:null,accountUpdateMillis:700,authenticate:function(e){console.log("Starting oauth flow..."),M.tradingEnabled?l():location.href=m(e)},authenticateWithWindow:function(e){return A()?(console.log("Window opener no supported in IE, redirecting to oauth..."),M.authenticate(e)):(console.log("Opening oauth window..."),void(M.auth_window=c(m(e),"osLaunch",450,450)))},openAddBrokerWindow:function(){A()&&window.open("https://api.tradable.com"),M.auth_window=c(M.add_broker_loc,"osAddBroker",450,450)},enableWithAccessToken:function(e,t,n){M.enableTrading(e,t,n,!0)},signOut:function(){o()&&(localStorage.removeItem("accessToken:"+h),localStorage.removeItem("authEndpoint:"+h),localStorage.removeItem("tradingEnabled:"+h),localStorage.removeItem("expirationTimeUTC:"+h)),M.tradingEnabled=!1,r()},onEmbedReady:function(e){M.readyCallbacks.push(e),M.notifiedCallbacks&&e()},onAccountUpdated:function(e){if(e){0===F.length&&(M.accountUpdateInterval=setInterval(f,M.accountUpdateMillis));var n=g(e.toString());-1===t.inArray(n,R)&&(F.push(e),R.push(n))}},setAccountUpdateFrequencyMillis:function(e){e&&e>0?(M.accountUpdateMillis=e,M.accountUpdateInterval&&(clearInterval(M.accountUpdateInterval),M.accountUpdateInterval=setInterval(f,M.accountUpdateMillis))):console.error("Please specify a valid update frequency")},addSymbolToUpdates:function(e,n){if(-1!==e.indexOf(":"))return void console.error("It is not allowed to include a colon ':' in the updateClientId");var o=n+":"+e;-1===t.inArray(o,M.symbolKeysForAccountUpdates)&&-1!==t.inArray(n,M.availableSymbols)&&M.symbolKeysForAccountUpdates.push(o)},removeSymbolFromUpdates:function(e,n){var o=n+":"+e;M.symbolKeysForAccountUpdates=t.grep(M.symbolKeysForAccountUpdates,function(e){return e!=o})},onAccountSwitch:function(e){e&&-1===t.inArray(e,w)&&w.push(e)},onTokenExpired:function(e){e&&-1===t.inArray(e,C)&&C.push(e)},onError:function(e){-1===t.inArray(e,U)&&U.push(e)},onTokenWillExpire:function(e){function n(){var e=M.getRemainingTokenMillis();e&&e>0&&18e5>e&&t(q).each(function(t,n){n(e)})}0===q.length&&setInterval(n,3e5),-1===t.inArray(e,q)&&q.push(e)},getRemainingTokenMillis:function(){return M.expirationTimeUTC||console.log("You need to authenticate before calling this method"),M.expirationTimeUTC-(new Date).getTime()},makeOsRequest:function(e,n,o,c,r,u,s){var l;"user"!==e&&"accounts"!==e?l="https://"+E:void 0!==o&&null!==o&&0===o.length?l=M.authEndpoint:M.accountMap[o]?l=M.accountMap[o].endpointURL:console.info("Please specify a valid accountId or method");var d=t.ajax({type:n,beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+M.accessToken),e.setRequestHeader("x-tr-embed-sdk",v)},crossDomain:!0,url:o&&o.length>0?l+"/v1/"+e+"/"+o+"/"+c:l+"/v1/"+e+"/"+c,contentType:"application/json; charset=utf-8",data:r?JSON.stringify(r):void 0,dataType:"json"});return d.then(function(){},function(e,t,n){!e.responseJSON||403!==e.responseJSON.httpStatus&&502!==e.responseJSON.httpStatus||(a(),i(e.responseJSON))}),u||s?d.then(function(e){return"function"==typeof u?u(e):void 0},function(e,t,n){return"function"==typeof s?s(e,t,n):void 0}):"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(d):d},makeAccountRequest:function(e,t,n,o,c,r){return M.makeOsRequest("accounts",e,t,n,o,c,r)},setSelectedAccount:function(e,t,n){return M.accountMap[e]?(M.selectedAccount=M.accountMap[e],M.selectedAccountId=e,console.log("accountId is set to: "+e),s(function(){o()&&localStorage.setItem("selectedAccount:"+h,e),t&&t()},function(e){(502===e.status||403===e.status)&&(M.excludeCurrentAccount(),M.accounts.length>0&&l()),n&&n(e)})):void console.error("Can't set account id to: "+e)},excludeCurrentAccount:function(){var e=M.selectedAccountId,t=M.accounts.indexOf(M.selectedAccount);t>-1&&M.accounts.splice(t,1),delete M.accountMap[e],M.accountIdsToExclude.push(e)},getInstrumentFromSymbol:function(e){if(!e)return null;var n=null;return t(M.availableInstruments).each(function(t,o){return o.symbol.toUpperCase()===e.toUpperCase()?(n=o,!1):void 0}),n},getInstrumentFromBrokerageAccountSymbol:function(e){var n=null;return t(M.availableInstruments).each(function(t,o){return o.brokerageAccountSymbol.toUpperCase()===e.toUpperCase()?(n=o,!1):void 0}),n},getAccountById:function(e){return M.accountMap[e]},getUser:function(e,t){return M.makeOsRequest("user","GET","","",null,e,t)},getAppInfo:function(e,t){return M.makeOsRequest("apps","GET","",M.app_id,null,e,t)},getBrokers:function(e,t){return M.makeOsRequest("brokers","GET","","",null,e,t)},authenticateWithCredentials:function(e,n,o,c,r){var a,i=new t.Deferred,u={appId:M.app_id,brokerId:e,login:n,password:o};return M.makeOsRequest("authenticate","POST","","",u).then(function(e){return a=e,M.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)}).then(function(){i.resolve(a)},function(e){i.reject(e)}),p(i,c,r)},createDemoAccount:function(e,n,o){var c,r=new t.Deferred,a={appId:M.app_id,type:e};return M.makeOsRequest("createDemoAccount","POST","","",a).then(function(e){return c=e,M.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)}).then(function(){r.resolve(c)},function(e){r.reject(e)}),p(r,n,o)},createForexDemoAccount:function(e,t){return M.createDemoAccount("FOREX",e,t)},createStocksDemoAccount:function(e,t){return M.createDemoAccount("STOCKS",e,t)},refreshAuthentication:function(e,n,o,c){var r=new t.Deferred,a={refreshTokenValue:e};n&&(a={refreshTokenValue:e,appSecret:n});var i;return M.makeOsRequest("refreshAuthentication","POST","","",a).then(function(e){return i=e,M.enableTrading(e.apiTokenValue,e.apiEndpoint,e.expires)}).then(function(){r.resolve(i)},function(e){r.reject(e)}),p(r,o,c)},getAccounts:function(e,n){var o=M.makeAccountRequest("GET","","",null).then(function(e){M.accounts.splice(0,M.accounts.length),M.accountMap={},t(e.accounts).each(function(e,t){t.uniqueId&&"NA"!==t.uniqueId&&M.accountIdsToExclude.indexOf(t.uniqueId)<=-1&&(M.accounts.push(t),M.accountMap[t.uniqueId]=t)})});return p(o,e,n)},getCandles:function(e,t,n,o,c,r){return M.getCandlesForAccount(M.selectedAccountId,e,t,n,o,c,r)},getCandlesForAccount:function(e,t,n,o,c,r,a){var i={symbol:t,from:n,to:o,aggregation:c};return M.makeAccountRequest("POST",e,"candles/",i,r,a)},getSnapshot:function(e,t,n){return M.getSnapshotForAccount(M.selectedAccountId,e,t,n)},getSnapshotForAccount:function(e,t,n,o){var c={symbols:t};return M.makeAccountRequest("POST",e,"",c,n,o)},getInstruments:function(e,t){return M.getInstrumentsForAccount(M.selectedAccountId,e,t)},getInstrumentsForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"instruments/",null,t,n)},getMetrics:function(e,t){return M.getMetricsForAccount(M.selectedAccountId,e,t)},getMetricsForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"metrics/",null,t,n)},getOrders:function(e,t){return M.getOrdersForAccount(M.selectedAccountId,e,t)},getOrdersForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"orders/",null,t,n)},placeMarketOrder:function(e,t,n,o,c){return M.placeOrder(e,0,t,n,"MARKET",o,c)},placeMarketOrderForAccount:function(e,t,n,o,c,r){return M.placeOrderForAccount(e,t,0,n,o,"MARKET",c,r)},placeLimitOrder:function(e,t,n,o,c,r){return M.placeOrder(e,t,n,o,"LIMIT",c,r)},placeLimitOrderForAccount:function(e,t,n,o,c,r,a){return M.placeOrderForAccount(e,t,n,o,c,"LIMIT",r,a)},placeStopOrder:function(e,t,n,o,c,r){return M.placeOrder(e,t,n,o,"STOP",c,r)},placeStopOrderForAccount:function(e,t,n,o,c,r,a){return M.placeOrderForAccount(e,t,n,o,c,"STOP",r,a)},placeOrder:function(e,t,n,o,c,r,a){return M.placeOrderForAccount(M.selectedAccountId,e,t,n,o,c,r,a)},placeOrderForAccount:function(e,t,n,o,c,r,a,i){var u={amount:t,price:n,side:o,symbol:c,type:r};return M.makeAccountRequest("POST",e,"orders/",u,a,i)},placeOrderWithProtections:function(e,t,n,o,c,r,a,i,u){return M.placeOrderWithProtectionsForAccount(M.selectedAccountId,e,t,n,o,c,r,a,i,u)},placeOrderWithProtectionsForAccount:function(e,t,n,o,c,r,a,i,u,s){var l={amount:t,price:n,side:o,symbol:c,type:r};return a&&(l.takeProfitDistance=a),i&&(l.stopLossDistance=i),M.makeAccountRequest("POST",e,"orders/",l,u,s)},getPendingOrders:function(e,t){return M.getPendingOrdersForAccount(M.selectedAccountId,e,t)},getPendingOrdersForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"orders/pending",null,t,n)},getOrderById:function(e,t,n){return M.getOrderByIdForAccount(M.selectedAccountId,e,t,n)},getOrderByIdForAccount:function(e,t,n,o){return M.makeAccountRequest("GET",e,"orders/"+t,null,n,o)},modifyOrderPrice:function(e,t,n,o){return M.modifyOrderPriceForAccount(M.selectedAccountId,e,t,n,o)},modifyOrderPriceForAccount:function(e,t,n,o,c){var r={price:n};return M.makeAccountRequest("PUT",e,"orders/"+t,r,o,c)},cancelOrder:function(e,t,n){return M.cancelOrderForAccount(M.selectedAccountId,e,t,n)},cancelOrderForAccount:function(e,t,n,o){return M.makeAccountRequest("DELETE",e,"orders/"+t,null,n,o)},getPositions:function(e,t){return M.getPositionsForAccount(M.selectedAccountId,e,t)},getPositionsForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"positions/",null,t,n)},closeAllPositions:function(e,t){return M.closeAllPositionsForAccount(M.selectedAccountId,e,t)},closeAllPositionsForAccount:function(e,t,n){return M.makeAccountRequest("DELETE",e,"positions/",null,t,n)},getOpenPositions:function(e,t){return M.getOpenPositionsForAccount(M.selectedAccountId,e,t)},getOpenPositionsForAccount:function(e,t,n){return M.makeAccountRequest("GET",e,"positions/open",null,t,n)},getPositionById:function(e,t,n){return M.getPositionByIdForAccount(M.selectedAccountId,e,t,n)},getPositionByIdForAccount:function(e,t,n,o){return M.makeAccountRequest("GET",e,"positions/"+t,null,n,o)},reducePositionToAmount:function(e,t,n,o){return M.reducePositionToAmountForAccount(M.selectedAccountId,e,t,n,o)},reducePositionToAmountForAccount:function(e,t,n,o,c){var r={amount:n};return M.makeAccountRequest("PUT",e,"positions/"+t,r,o,c)},closePosition:function(e,t,n){return M.closePositionForAccount(M.selectedAccountId,e,t,n)},closePositionForAccount:function(e,t,n,o){return M.makeAccountRequest("DELETE",e,"positions/"+t,null,n,o)},addOrModifyProtections:function(e,t,n,o,c){return M.addOrModifyProtectionsForAccount(M.selectedAccountId,e,t,n,o,c)},addOrModifyProtectionsForAccount:function(e,t,n,o,c,r){var a={takeprofit:n,stoploss:o};return M.makeAccountRequest("PUT",e,"positions/"+t+"/protections/",a,c,r)},cancelProtections:function(e,t,n){return M.cancelProtectionsForAccount(M.selectedAccountId,e,t,n)},cancelProtectionsForAccount:function(e,t,n,o){return M.makeAccountRequest("DELETE",e,"positions/"+t+"/protections/",null,n,o)},addOrModifyTakeProfit:function(e,t,n,o){return M.makeProtectionRequest("PUT",e,t,"TAKEPROFIT",n,o)},addOrModifyTakeProfitForAccount:function(e,t,n,o,c){return M.makeProtectionRequestForAccount("PUT",e,t,n,"TAKEPROFIT",o,c)},addOrModifyStopLoss:function(e,t,n,o){return M.makeProtectionRequest("PUT",e,t,"STOPLOSS",n,o)},addOrModifyStopLossForAccount:function(e,t,n,o,c){return M.makeProtectionRequestForAccount("PUT",e,t,n,"STOPLOSS",o,c)},cancelTakeProfit:function(e,t,n){return M.makeProtectionRequest("DELETE",e,0,"TAKEPROFIT",t,n)},cancelTakeProfitForAccount:function(e,t,n,o){return M.makeProtectionRequestForAccount("DELETE",e,t,0,"TAKEPROFIT",n,o)},cancelStopLoss:function(e,t,n){return M.makeProtectionRequest("DELETE",e,0,"STOPLOSS",t,n)},cancelStopLossForAccount:function(e,t,n,o){return M.makeProtectionRequestForAccount("DELETE",e,t,0,"STOPLOSS",n,o)},makeProtectionRequest:function(e,t,n,o,c,r){return M.makeProtectionRequestForAccount(e,M.selectedAccountId,t,n,o,c,r)},makeProtectionRequestForAccount:function(e,t,n,o,c,r,a){var i={price:o};return"DELETE"===e&&(i=null),M.makeAccountRequest(e,t,"positions/"+n+"/protections/"+c,i,r,a)},getPrices:function(e,t,n){return M.getPricesForAccount(M.selectedAccountId,e,t,n)},getPricesForAccount:function(e,t,n,o){var c={symbols:t};return M.makeAccountRequest("POST",e,"prices/",c,n,o)},makeCandleRequest:function(e,n,o,c,r){var a={symbols:n};r&&(a=r);var i=t.ajax({type:"POST",crossDomain:!0,url:"https://candles-api.tradable.com/"+e,contentType:"application/json; charset=utf-8",data:JSON.stringify(a),dataType:"json"});if(o||c)return i.then(function(e){return"function"==typeof o?o(e.dailyClose?e.dailyClose:e):void 0},function(e,t,n){return"function"==typeof c?c(e,t,n):void 0});var u=new t.Deferred;return i.then(function(e){return e.dailyClose?u.resolve(e.dailyClose):u.resolve(e)},function(e,t,n){return u.reject(e,t,n)}),"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")?Promise.resolve(u.promise()):u.promise()},getLastDailyClose:function(e,t,n){return M.makeCandleRequest("dailyClose",e,t,n)},enableTrading:function(e,n,c,r){var a=new t.Deferred;console.log("Activating TradableEmbed..."),e&&n&&(M.accessToken=e,M.authEndpoint=n,M.tradingEnabled=!0,o()&&(localStorage.setItem("accessToken:"+h,M.accessToken),localStorage.setItem("authEndpoint:"+h,M.authEndpoint),localStorage.setItem("tradingEnabled:"+h,M.tradingEnabled),c&&(M.expirationTimeUTC=(new Date).getTime()+1e3*parseInt(c),localStorage.setItem("expirationTimeUTC:"+h,M.expirationTimeUTC))));var i=M.accounts.length;return M.getAccounts().then(function(e){return d(r,i)}).then(function(){a.resolve()},function(e){a.reject(e)}),a}};n(),e.trEmbJQ=trEmbJQ,e.tradableEmbed=M,"function"==typeof require&&"object"==typeof module&&module&&module.exports&&(module.exports=M)}(jsGlobalObject,trEmbJQ);